### **Руководство по настройке оглавления (Table Of Contents)**

В этом руководстве описан процесс автоматического создания оглавления (TOC) в WordPress с использованием файла `content.table-of-contents-data.php`. Ниже приведены основные принципы работы и рекомендации по настройке.

---

## **Что такое Table Of Contents?**

TOC автоматически добавляет уникальные идентификаторы к заголовкам (`h1`, `h2`, `h3` и другим, если указано) и собирает их в массив для формирования оглавления. Это упрощает навигацию по длинным статьям и делает контент более удобным для пользователей.

---

## **Как работает механизм?**

### **Глобальная переменная и обработка данных**

В файле `includes/content.table-of-contents-data.php` реализован код, который:
- Создаёт и заполняет глобальную переменную `$tableOfContentsData`, содержащую массив заголовков и их идентификаторов.
- Пример структуры:
  ```php
  global $tableOfContentsData;
  [
      [
          'title' => 'Заголовок',
          'id'    => 'unique-id'
      ],
      // ...
  ]
  ```
Эта переменная доступна в любой части темы и может быть использована для вывода оглавления.

### **Как обрабатываются заголовки?**

Функция `add_unique_id_to_headings`, привязанная к хуку `the_content`, выполняет следующие задачи:
- Добавляет уникальные идентификаторы к заголовкам (`h1`, `h2`, `h3` или другим, если указано в настройках).
- Собирает текст заголовков и их идентификаторы в массив `$tableOfContentsData`.

Обработка заголовков происходит в двух случаях:
1. **Автоматическая обработка** – если тип поста включён в `$autoProcessPostTypes` (например, `'blog'`), обрабатываются все заголовки, указанные в `$targetHeadingLevels`.
2. **Обработка внутри контейнера** – если заголовки находятся внутри элемента с классом `$wrapperClass` (по умолчанию `table-of-contents-target`).

> **Важно!** Чтобы заголовки были обработаны, необходимо:
> - Указать тип поста в `$autoProcessPostTypes`, **или**
> - Разместить заголовки внутри контейнера с классом `$wrapperClass`.

### **Обработка заголовков внутри специальных комментариев**

Дополнительно можно указывать области контента, которые должны быть обработаны, с помощью специальных комментариев. Это полезно для гибкого управления структурой.

- **Открывающий комментарий** ищется по его началу, что позволяет добавлять в него дополнительные параметры (например, JSON с настройками).
- **Закрывающий комментарий** определяется по точному соответствию.

Пары таких комментариев указываются в массиве `$wrappingSubstringPairs`.

Пример:
```html
<!-- wp:carbon-fields/page-typography-content-wrapper {"data":{"images":[],"margin_bottom":"mb-0-25"}} -->
    <h2>Заголовок внутри блока</h2>
<!-- /wp:carbon-fields/page-typography-content-wrapper -->
```
Даже если в открывающем комментарии есть JSON, заголовки внутри него всё равно будут обработаны.

---

## **Как получить доступ к оглавлению?**

Оглавление доступно через глобальную переменную `$tableOfContentsData`. Для вывода ссылок на заголовки можно использовать следующий код:

```php
global $tableOfContentsData;
foreach ($tableOfContentsData as $heading) {
    echo '<a href="#' . $heading['id'] . '">' . $heading['title'] . '</a><br>';
}
```

---

## **Как подготовить контент для работы TOC?**

Чтобы обеспечить корректную обработку заголовков, выполните одно из следующих условий:

1. **Автоматическая обработка** – Укажите тип поста в `$autoProcessPostTypes`, и все заголовки выбранных уровней будут обработаны.
2. **Обработка внутри контейнера** – Разместите заголовки внутри блока с классом `$wrapperClass` (по умолчанию `table-of-contents-target`).
3. **Обрамление заголовков комментариями** – Используйте специальные комментарии, если необходимо выделить область, содержащую заголовки.

### **Пример разметки**

**Контейнерный метод:**
```html
<div class="table-of-contents-target">
    <h1>Основной заголовок</h1>
    <h2>Подзаголовок</h2>
    <h3>Дополнительный заголовок</h3>
</div>
```

**Использование комментариев:**
```html
<!-- wp:carbon-fields/page-typography-content-wrapper {"data":{"...": "..."}} -->
    <h2>Заголовок внутри блока</h2>
<!-- /wp:carbon-fields/page-typography-content-wrapper -->
```
В этом случае обработка будет происходить внутри отмеченной области.

---

## **Вывод**

Table Of Contents в WordPress позволяет:
- Добавлять уникальные идентификаторы к заголовкам (`h1`, `h2`, `h3` и другим, если требуется).
- Автоматически собирать данные заголовков в массив `$tableOfContentsData`.
- Гибко управлять обработкой заголовков через CSS-класс контейнера или специальные комментарии.

Система обеспечивает удобную навигацию по длинным статьям и улучшает пользовательский опыт.